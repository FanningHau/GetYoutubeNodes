name: æ¯æ—¥æå–å¹¶æ›´æ–°å†…å®¹

on:
  schedule:
    # æ¯å¤© 10:00 (UTC æ—¶é—´) è¿è¡Œ
    - cron: '0 10 * * *'
  
  workflow_dispatch:

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # (!!) æ­¥éª¤ 3: (å·²åˆ é™¤ FFmpeg å®‰è£…)

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # (!!) ä¾èµ–å·²ç§»é™¤ yt-dlp
          pip install google-api-python-client gdown
      
      # (!!) æ­¥éª¤ 5: æ³¨å…¥ Secrets (å·²ç§»é™¤ YOUTUBE_COOKIES)
      - name: Run Python script
        run: python getnodes_modified.py 
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          VIDEO_ID: ${{ secrets.VIDEO_ID }}        
          ZIP_PASSWORD: ${{ secrets.ZIP_PASSWORD }}    

      # (!!) æ­¥éª¤ 6: æäº¤æ‰€æœ‰æ–‡ä»¶ (ä¿æŒä¸å˜)
      # (git add . ä¼šæäº¤ temp_downloads å’Œæ ¹ç›®å½•çš„ .txt)
      - name: Commit and push extracted content
        run: |
          git config --global user.name 'fanning'
          git config --global user.email 'haofanning@gmail.com'
          
          git add .
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            echo "ğŸš€ å‘ç°å†…å®¹æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
            git commit -m "Automated update: æå–å¹¶æ›´æ–°è®¢é˜…å†…å®¹ (${{ env.TODAY_DATE }})"
            git push
          fi
        env:
          TODAY_DATE: $(date +'%Y-%m-%d')
