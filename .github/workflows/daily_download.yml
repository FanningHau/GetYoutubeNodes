name: æ¯æ—¥æå–å¹¶æ›´æ–°å†…å®¹

on:
  schedule:
    - cron: '0 8 * * *'
  
  workflow_dispatch:

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client gdown yt-dlp
      
      # (!!) --- å…³é”®æ”¹åŠ¨åœ¨è¿™é‡Œ ---
      - name: Run Python script
        run: python getnodes_modified.py # è¿è¡Œæˆ‘ä»¬ä¿®æ”¹åçš„è„šæœ¬
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          VIDEO_ID: ${{ secrets.VIDEO_ID }}        # <-- æ–°å¢
          ZIP_PASSWORD: ${{ secrets.ZIP_PASSWORD }}    # <-- æ–°å¢

      # (!!) --- æäº¤æ­¥éª¤ (ä¿æŒä¸å˜) ---
      - name: Commit and push extracted content
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ${{ env.FINAL_CONTENT_FILE_NAME }}
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… æ–‡æœ¬å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            echo "ğŸš€ å‘ç°æ–‡æœ¬å†…å®¹æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
            git commit -m "Automated update: æå–å¹¶æ›´æ–°è®¢é˜…å†…å®¹ (${{ env.TODAY_DATE }})"
            git push
          fi
        env:
          FINAL_CONTENT_FILE_NAME: "subscription_content.txt" 
          TODAY_DATE: $(date +'%Y-%m-%d')
