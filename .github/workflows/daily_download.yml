name: æ¯æ—¥æå–å¹¶æ›´æ–°å†…å®¹

on:
  schedule:
    - cron: '0 8 * * *'
  
  workflow_dispatch:

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # (æ­¥éª¤ 1-4 ä¿æŒä¸å˜: Checkout, Set up Python, Install FFmpeg, Install Python deps)
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client gdown yt-dlp
      
      # (æ­¥éª¤ 5 ä¿æŒä¸å˜: æ³¨å…¥æ‰€æœ‰ secrets)
      - name: Run Python script
        run: python getnodes_modified.py 
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          VIDEO_ID: ${{ secrets.VIDEO_ID }}        
          ZIP_PASSWORD: ${{ secrets.ZIP_PASSWORD }}    

      # (!!) --- æ­¥éª¤ 6: (æ ¸å¿ƒä¿®æ”¹) æäº¤æ‰€æœ‰å˜åŠ¨çš„æ–‡ä»¶ ---
      - name: Commit and push extracted content
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # (!!) ä¿®æ”¹ç‚¹: ä¸å†æ·»åŠ ç‰¹å®šæ–‡ä»¶ï¼Œè€Œæ˜¯æ·»åŠ æ‰€æœ‰æ–°æ–‡ä»¶/å˜åŠ¨æ–‡ä»¶
          git add .
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… æ–‡æœ¬å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            echo "ğŸš€ å‘ç°æ–‡æœ¬å†…å®¹æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
            # (!!) æäº¤ä¿¡æ¯ä¿æŒé€šç”¨
            git commit -m "Automated update: æå–å¹¶æ›´æ–°è®¢é˜…å†…å®¹ (${{ env.TODAY_DATE }})"
            git push
          fi
        env:
          # (!!) ä¸å†éœ€è¦ FINAL_CONTENT_FILE_NAME
          TODAY_DATE: $(date +'%Y-%m-%d')
